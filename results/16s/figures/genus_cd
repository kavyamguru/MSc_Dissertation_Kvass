# ğŸ“¦ Load libraries
library(tidyverse)
library(readr)
library(ggrepel)    # for non-overlapping labels

# ğŸ“ Define file paths
ordination_fp <- "ordination.txt"
metadata_fp   <- "/Users/kavya/B269797/metadata/16s/16s_metadata.tsv"

# âœ… Read variance explained
prop_values <- read_tsv(ordination_fp,
                        skip = 4, n_max = 1,
                        col_names = FALSE,
                        col_types = cols(.default = col_double()),
                        show_col_types = FALSE)
pc1_pct <- round(prop_values[[1]] * 100, 2)
pc2_pct <- round(prop_values[[2]] * 100, 2)

# ğŸ”¹ Load ordination coordinates
ordination_raw <- suppressWarnings(
  read_tsv(ordination_fp,
           skip = 9,
           col_names = FALSE,
           show_col_types = FALSE)
)
colnames(ordination_raw) <- c("SampleID", paste0("PC", 1:(ncol(ordination_raw)-1)))

ordination_clean <- ordination_raw %>%
  filter(!SampleID %in% c("Site", "Biplot", "Site constraints"))

# ğŸ”¹ Load metadata and rename the first column
metadata <- read_tsv(metadata_fp, show_col_types = FALSE) %>%
  rename(SampleID = `#SampleID`)

# ğŸ”— Merge
ordination <- left_join(ordination_clean, metadata, by = "SampleID")

# ğŸ¨ PCoA plotting function (with repel)
make_pcoa_plot <- function(data, color_var, title, file_name) {
  df <- data %>%
    mutate(across(all_of(color_var), as.character)) %>%
    filter(!is.na(.data[[color_var]]), .data[[color_var]] != "") %>%
    mutate(!!color_var := droplevels(factor(.data[[color_var]])))
  
  p <- ggplot(df, aes(x = PC1, y = PC2, color = .data[[color_var]])) +
    geom_point(size = 4) +
    geom_text_repel(aes(label = SampleID), 
                    size = 3.5,
                    box.padding   = 0.3,
                    point.padding = 0.5,
                    show.legend   = FALSE) +
    labs(
      title = paste("PCoA (Brayâ€“Curtis) â€”", title),
      x     = paste0("PC1 (", pc1_pct, "%)"),
      y     = paste0("PC2 (", pc2_pct, "%)"),
      color = title
    ) +
    theme_bw(base_size = 14) +
    theme(
      panel.grid.major = element_line(color = "grey80"),
      panel.grid.minor = element_blank()
    ) +
    # if coloring by SampleID, drop the legend
    if (color_var == "SampleID") guides(color = "none") else NULL
  
  ggsave(filename = file_name, plot = p, width = 8, height = 6, dpi = 300)
}

# ğŸ“Š Loop through all variables including SampleID
plot_list <- c(
  Starter_Identity = "Starter Identity",
  Sample_Type      = "Sample Type",
  Inulin           = "Inulin Presence",
  Ginger           = "Ginger Presence",
  Sugar_Content    = "Sugar Content",
  SampleID         = "Sample ID"
)

for (var in names(plot_list)) {
  make_pcoa_plot(
    data      = ordination,
    color_var = var,
    title     = plot_list[[var]],
    file_name = paste0("PCoA_", var, ".png")
  )
}

cat("âœ… All PCoA plots saved â€” labels repelled and panel lightened.\n")
